<head>
  <meta charset="utf-8">
  <title>{% if page.layout == 'post' or page.hideHomeActive or page.is404 %}{{ page.title }} - {% endif %}{{ site.title }}</title>
  <meta name="description" content="{{ site.description }}{% if page.categories %}{{ page.categories }}{% endif %}{% if page.summary %}{{ page.summary }}{% endif %}">
  {% if page.tags %}
  <meta name="keywords" content="{{ page.tags | join: ', ' }}">
  {% endif %}

  <!-- Viewport and Theme Color -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#FFFFFF">
  
  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' 
      https://gw.alipayobjects.com 
      https://www.googletagmanager.com 
      https://hm.baidu.com 
      https://tongji.chiloh.com;
    style-src 'self' 'unsafe-inline' 
      https://gw.alipayobjects.com 
      https://fonts.loli.net;
    img-src 'self' data: https: 
      https://chilohdata.s3.bitiful.net 
      https://gw.alipayobjects.com 
      https://gw.alicdn.com 
      https://cdn.fliggy.com;
    font-src 'self' 
      https://gw.alipayobjects.com 
      https://fonts.loli.net
      https://gstatic.loli.net;
    connect-src 'self' 
      https://tongji.chiloh.com 
      https://hm.baidu.com 
      https://www.google-analytics.com
      https://api.microlink.io;
    media-src 'self' https:;
    frame-src 'none';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    upgrade-insecure-requests;
  ">

  <!-- Open Graph Metadata -->
  <meta property="og:locale" content="{{ site.lang }}">
  <meta property="og:title" content="{% if page.title %}{{ page.title }} - Chiloh{% else %}{{ site.title }}{% endif %}">
  <meta property="og:description" content="{% if page.summary %}{{ page.summary }}{% else %}{{ site.description }}{% endif %}">
  <meta property="og:url" content="{{ site.url }}{{ page.url }}">
  <meta property="og:site_name" content="{{ site.title }}">
  {% if page.feature %}
  <meta property="og:image" content="{{ page.feature }}">
  {% else %}
  <meta property="og:image" content="https://chilohdata.s3.bitiful.net/avatar.png">
  {% endif %}

  <!-- Twitter Metadata -->
  {% if page.layout == "post" %}
  <meta name="twitter:card" content="{% if page.feature %}summary_large_image{% else %}summary{% endif %}">
  <meta name="twitter:creator" content="@{{ site.twitter }}">
  <meta name="twitter:site" content="{{ site.url }}">
  <meta name="twitter:url" content="{{ site.url }}{{ page.url }}">
  <meta name="twitter:title" content="{{ page.title }} - Chiloh Wei">
  <meta name="twitter:description" content="{{ page.summary }}">
  <meta name="twitter:image" content="{% if page.feature %}{{ page.feature }}{% else %}https://gw.alicdn.com/imgextra/i3/O1CN01cSkdn72AKKBDPm829_!!6000000008184-2-tps-2664-2664.png{% endif %}">
  {% endif %}

  <!-- Canonical URL -->
  {% capture canonical %}{{ site.url }}{% if site.permalink contains '.html' %}{{ page.url }}{% else %}{{ page.url | remove: 'index.html' | strip_slash }}{% endif %}{% endcapture %}
  <link rel="canonical" href="{{ canonical }}">
  
  <!-- Hreflang for multilingual support -->
  {% if page.layout == 'post' %}
    {% assign post_name = page.path | remove: '_posts/' | remove: '_posts_en/' | remove: '.md' %}
    {% for post in site.posts %}
      {% assign other_post_name = post.path | remove: '_posts/' | remove: '.md' %}
      {% if other_post_name == post_name %}
        <link rel="alternate" hreflang="zh-CN" href="{{ site.url }}{{ post.url }}" />
      {% endif %}
    {% endfor %}
    {% for post in site.posts_en %}
      {% assign other_post_name = post.path | remove: '_posts_en/' | remove: '.md' %}
      {% if other_post_name == post_name %}
        <link rel="alternate" hreflang="en-US" href="{{ site.url }}{{ post.url }}" />
      {% endif %}
    {% endfor %}
    <link rel="alternate" hreflang="x-default" href="{{ canonical }}" />
  {% else %}
    <link rel="alternate" hreflang="zh-CN" href="{{ site.url }}/" />
    <link rel="alternate" hreflang="en-US" href="{{ site.url }}/en/" />
    <link rel="alternate" hreflang="x-default" href="{{ site.url }}/" />
  {% endif %}

  <!-- Critical CSS (inlined for faster first paint) -->
  <style>
    /* Critical above-the-fold styles */
    :root {
      --color-bg: #e8e8e8;
      --color-text: rgba(36, 41, 47, 0.9);
      --color-header: #15141a;
      --color-white: #fff;
      --color-link: rgba(36, 41, 47, 0.8);
      --menu-height: 60px;
      --font-base: "LXGW WenKai Screen R", Calibri, Arial, sans-serif;
    }
    *,*:after,*:before{box-sizing:border-box}
    html{font-size:100%;scroll-behavior:smooth}
    body{margin:0;padding:0;width:100%;background-color:var(--color-bg);font-family:var(--font-base);color:var(--color-text);letter-spacing:.5px;line-height:1.7;font-size:15px;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;overflow-x:hidden}
    .header-menu{position:absolute;top:0;left:0;width:100%;z-index:20;overflow:hidden;background-color:var(--color-white);height:var(--menu-height);box-shadow:0 0 0 0,0 6px 12px rgba(0,0,0,.1);padding:0 8px}
    @media only screen and (min-width:48em){.header-menu{position:fixed;padding:0;transition:.3s height ease-out}}
    .header-menu ul{margin:0 auto;list-style-type:none;height:100%;padding:0}
    .header-item,.header-item-title{float:right;padding-left:8px;padding-right:8px;height:100%;display:block}
    .header-item-title{float:left}
    .header-item a,.header-item-title a{vertical-align:middle;display:table-cell;height:var(--menu-height);font-size:16px;box-sizing:border-box;font-weight:700;text-decoration:none;color:var(--color-link)}
    .entry-header{position:relative;overflow:hidden;width:100%;height:260px;background:var(--color-header);display:none}
    @media only screen and (min-width:48em){.entry-header{display:block}}
  </style>

  <!-- Preload Critical Resources -->
  <link rel="preload" href="{{ site.baseurl }}/css/index.css" as="style">
  <link rel="preload" href="https://gw.alipayobjects.com/os/k/font/lxgwwenkaiscreenr.css" as="style" crossorigin="anonymous">
  
  <!-- Styles and Scripts -->
  <link rel="stylesheet" href="{{ site.baseurl }}/css/index.css">
  <link rel="stylesheet" href="{{ site.baseurl }}/css/buy-me-coffee.css">
  <!-- Font with font-display: swap for better loading -->
  <link rel="stylesheet" href="https://gw.alipayobjects.com/os/k/font/lxgwwenkaiscreenr.css" crossorigin="anonymous">
  <style>
    /* Ensure font-display: swap for custom fonts */
    @font-face {
      font-family: 'LXGW WenKai Screen R';
      font-display: swap;
    }
  </style>

  {% if page.lang == 'en-US' %}
  <link rel="preload" href="https://fonts.loli.net/css?family=Source+Serif+Pro:400,600,700&display=swap" as="style">
  <link href="https://fonts.loli.net/css?family=Source+Serif+Pro:400,600,700&display=swap" rel="stylesheet">
  {% endif %}

  {% if page.layout == "post" %}
  <link rel="preload" href="//gw.alipayobjects.com/os/k/tw93/lazysizes.min.js" as="script">
  <script src="//gw.alipayobjects.com/os/k/tw93/lazysizes.min.js" async></script>
  {% endif %}

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/png" href="https://chilohdata.s3.bitiful.net/avatar.png">

  <!-- Additional Meta Tags -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta http-equiv="cleartype" content="on">
  <link href="{{ site.url }}/feed.xml" type="application/atom+xml" rel="alternate" title="{{ site.title }} Feed">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "{% if page.layout == 'post' %}BlogPosting{% else %}WebSite{% endif %}",
    {% if page.layout == 'post' %}
    "headline": "{{ page.title | xml_escape }}",
    "description": "{% if page.summary %}{{ page.summary | xml_escape }}{% else %}{{ page.content | strip_html | truncate: 160 | xml_escape }}{% endif %}",
    "author": {
      "@type": "Person",
      "name": "{{ site.title }}",
      "url": "{{ site.url }}"
    },
    "publisher": {
      "@type": "Organization",
      "name": "{{ site.title }}",
      "logo": {
        "@type": "ImageObject",
        "url": "https://chilohdata.s3.bitiful.net/avatar.png"
      }
    },
    "datePublished": "{{ page.date | date_to_xmlschema }}",
    "dateModified": "{{ page.date | date_to_xmlschema }}",
    "url": "{{ site.url }}{{ page.url }}",
    {% if page.feature %}
    "image": "{{ page.feature }}",
    {% else %}
    "image": "https://chilohdata.s3.bitiful.net/avatar.png",
    {% endif %}
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "{{ site.url }}{{ page.url }}"
    },
    {% if page.categories %}
    "articleSection": "{{ page.categories | first }}",
    {% endif %}
    "inLanguage": "{{ page.lang | default: site.lang }}"
    {% else %}
    "name": "{{ site.title }}",
    "description": "{{ site.description | xml_escape }}",
    "url": "{{ site.url }}",
    "author": {
      "@type": "Person",
      "name": "{{ site.title }}",
      "url": "{{ site.url }}"
    },
    "publisher": {
      "@type": "Organization",
      "name": "{{ site.title }}",
      "logo": {
        "@type": "ImageObject",
        "url": "https://chilohdata.s3.bitiful.net/avatar.png"
      }
    },
    "potentialAction": {
      "@type": "SearchAction",
      "target": "{{ site.url }}/search?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
    {% endif %}
  }
  </script>

  <!-- Baidu Web Analytics -->
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5215f90c7272de316a5a210d7f288d56";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>    

</head>
